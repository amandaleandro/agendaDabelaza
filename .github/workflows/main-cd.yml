name: Deploy Agendei - Production


on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Tipo de versÃ£o'
        required: false
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Read version
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n' | tr -d '\r')
          if [ -z "$VERSION" ]; then echo "VERSION not found" && exit 1; fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using version: $VERSION"

      - name: Docker login
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: Build & push backend image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          docker build -t "$DOCKERHUB_USERNAME/agendei-backend:$VERSION" -f backend/Dockerfile backend
          docker push "$DOCKERHUB_USERNAME/agendei-backend:$VERSION"

      - name: Build & push frontend image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          docker build -t "$DOCKERHUB_USERNAME/agendei-frontend:$VERSION" -f frontend/Dockerfile frontend
          docker push "$DOCKERHUB_USERNAME/agendei-frontend:$VERSION"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          envs: DOCKERHUB_USERNAME,DOCKERHUB_TOKEN
          script: |
            set -e

            VERSION="${{ steps.version.outputs.version }}"
            DOMAIN="${{ secrets.DOMAIN || 'agendei.app' }}"
            echo "ðŸš€ Iniciando deploy da versÃ£o $VERSION"
            echo "ðŸ“ DomÃ­nio: $DOMAIN"

            # Garantir Docker e docker-compose instalados
            if ! command -v docker >/dev/null 2>&1; then
              curl -fsSL https://get.docker.com | sh
            fi
            if ! command -v docker-compose >/dev/null 2>&1; then
              curl -L "https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi
            # Tentar iniciar o serviÃ§o do Docker se nÃ£o estiver rodando
            if ! pgrep dockerd >/dev/null 2>&1; then
              sudo systemctl start docker 2>/dev/null || sudo service docker start 2>/dev/null || true
            fi

            # Adicionar usuÃ¡rio ao grupo docker se necessÃ¡rio
            if ! groups $USER | grep -q '\bdocker\b'; then
              sudo usermod -aG docker $USER
              echo "UsuÃ¡rio $USER adicionado ao grupo docker. FaÃ§a logout/login para aplicar."
            fi

            # Criar diretÃ³rio do projeto se nÃ£o existir
            mkdir -p ~/agendei
            cd ~/agendei

            # Login no Docker Hub
            echo "$DOCKERHUB_TOKEN" | sudo docker login -u "$DOCKERHUB_USERNAME" --password-stdin

            # Pull das novas imagens
            echo "ðŸ“¦ Baixando imagens Docker..."
            sudo docker pull $DOCKERHUB_USERNAME/agendei-backend:$VERSION
            sudo docker pull $DOCKERHUB_USERNAME/agendei-frontend:$VERSION

            # Criar/atualizar docker-compose.yml
            cat > docker-compose.yml << EOF
            version: '3.8'

            services:
              postgres:
                image: postgres:15-alpine
                container_name: agendei-postgres
                restart: always
                environment:
                  POSTGRES_USER: agendei
                  POSTGRES_PASSWORD: \${POSTGRES_PASSWORD}
                  POSTGRES_DB: agendei
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U agendei"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

              backend:
                image: $DOCKERHUB_USERNAME/agendei-backend:$VERSION
                container_name: agendei-backend
                restart: always
                depends_on:
                  postgres:
                    condition: service_healthy
                environment:
                  PORT: 3001
                  DATABASE_URL: postgresql://agendei:\${POSTGRES_PASSWORD}@postgres:5432/agendei
                  JWT_SECRET: \${JWT_SECRET}
                  JWT_EXPIRATION: \${JWT_EXPIRATION:-24h}
                  MERCADOPAGO_ACCESS_TOKEN: \${MERCADOPAGO_ACCESS_TOKEN}
                  NODE_ENV: production
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3001/api/health || exit 1"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 60s

              frontend:
                image: $DOCKERHUB_USERNAME/agendei-frontend:$VERSION
                container_name: agendei-frontend
                restart: always
                depends_on:
                  - backend
                environment:
                  NEXT_PUBLIC_API_URL: \${NEXT_PUBLIC_API_URL}
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000 || exit 1"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 60s

              nginx:
                image: nginx:alpine
                container_name: agendei-nginx
                restart: always
                depends_on:
                  - frontend
                  - backend
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                  - ./certbot/conf:/etc/letsencrypt:ro
                  - ./certbot/www:/var/www/certbot:ro
                networks:
                  - agendei-network

            volumes:
              postgres_data:

            networks:
              agendei-network:
                driver: bridge
            EOF

            # Criar arquivo nginx.conf se nÃ£o existir
            if [ ! -f nginx.conf ]; then
              echo "ðŸ“ Criando arquivo nginx.conf padrÃ£o..."
              # Remover diretÃ³rio nginx.conf se existir
              [ -d nginx.conf ] && rm -rf nginx.conf
              cat > nginx.conf << NGINX_EOF
            user nginx;
            worker_processes auto;
            error_log /var/log/nginx/error.log warn;
            pid /var/run/nginx.pid;

            events {
              worker_connections 1024;
            }

            http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;

              log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                              '$status $body_bytes_sent "$http_referer" '
                              '"$http_user_agent" "$http_x_forwarded_for"';

              access_log /var/log/nginx/access.log main;

              sendfile on;
              tcp_nopush on;
              tcp_nodelay on;
              keepalive_timeout 65;
              types_hash_max_size 2048;

              upstream frontend {
                server agendei-frontend:3000;
              }

              upstream backend {
                server agendei-backend:3001;
              }

              server {
                listen 80;
                server_name $DOMAIN 201.23.17.230 _;

                location / {
                  proxy_pass http://frontend;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_cache_bypass $http_upgrade;
                }

                location /api {
                  proxy_pass http://backend;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                }
              }
            }
            NGINX_EOF
            fi

            # Criar arquivo .env se nÃ£o existir
            if [ ! -f .env ]; then
              echo "âš ï¸  Criando arquivo .env - CONFIGURE AS VARIÃVEIS!"
              cat > .env << 'ENVEOF'
            POSTGRES_PASSWORD=***
            JWT_SECRET=***
            JWT_EXPIRATION=24h
            MERCADOPAGO_ACCESS_TOKEN=***

            NEXT_PUBLIC_API_URL=
            ENVEOF
            fi

            # Parar containers antigos
            echo "ðŸ›‘ Parando containers antigos..."
            sudo docker-compose down --remove-orphans || true

            # Iniciar novos containers
            echo "ðŸš€ Iniciando novos containers..."
            sudo docker-compose up -d

            # Aguardar backend ficar saudÃ¡vel
            echo "â³ Aguardando backend inicializar..."
            sleep 10

            # Executar migraÃ§Ãµes
            echo "ðŸ“Š Executando migraÃ§Ãµes do banco..."
            sudo docker exec agendei-backend npx prisma migrate deploy || echo "âš ï¸  Erro nas migraÃ§Ãµes - verifique manualmente"

            # Limpar imagens antigas
            echo "ðŸ§¹ Limpando imagens antigas..."
            sudo docker image prune -af --filter "until=72h" || true

            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ðŸ“Š Status dos containers:"
            sudo docker-compose ps
