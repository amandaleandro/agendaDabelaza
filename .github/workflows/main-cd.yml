name: Deploy Agendei - Production


on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Tipo de versÃ£o'
        required: false
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            set -e

            echo "ðŸš€ Iniciando deploy da versÃ£o 0.0.15"

            # Garantir Docker e docker-compose instalados
            if ! command -v docker >/dev/null 2>&1; then
              curl -fsSL https://get.docker.com | sh
            fi
            if ! command -v docker-compose >/dev/null 2>&1; then
              curl -L "https://github.com/docker/compose/releases/download/v2.27.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi
            # Tentar iniciar o serviÃ§o do Docker se nÃ£o estiver rodando
            if ! pgrep dockerd >/dev/null 2>&1; then
              sudo systemctl start docker 2>/dev/null || sudo service docker start 2>/dev/null || true
            fi

            # Adicionar usuÃ¡rio ao grupo docker se necessÃ¡rio
            if ! groups $USER | grep -q '\bdocker\b'; then
              sudo usermod -aG docker $USER
              echo "UsuÃ¡rio $USER adicionado ao grupo docker. FaÃ§a logout/login para aplicar."
            fi

            # Criar diretÃ³rio do projeto se nÃ£o existir
            mkdir -p ~/agendei
            cd ~/agendei

            # Login no Docker Hub
            echo "***" | sudo docker login -u "***" --password-stdin

            # Pull das novas imagens
            echo "ðŸ“¦ Baixando imagens Docker..."
            sudo docker pull ***/agendei-backend:0.0.15
            sudo docker pull ***/agendei-frontend:0.0.15

            # Criar/atualizar docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            version: '3.8'

            services:
              postgres:
                image: postgres:15-alpine
                container_name: agendei-postgres
                restart: always
                environment:
                  POSTGRES_USER: agendei
                  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                  POSTGRES_DB: agendei
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U agendei"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

              backend:
                image: ***/agendei-backend:0.0.15
                container_name: agendei-backend
                restart: always
                depends_on:
                  postgres:
                    condition: service_healthy
                environment:
                  PORT: 3001
                  DATABASE_URL: postgresql://agendei:${POSTGRES_PASSWORD}@postgres:5432/agendei
                  JWT_SECRET: ${JWT_SECRET}
                  JWT_EXPIRATION: ${JWT_EXPIRATION:-24h}
                  MERCADOPAGO_ACCESS_TOKEN: ${MERCADOPAGO_ACCESS_TOKEN}
                  NODE_ENV: production
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

              frontend:
                image: ***/agendei-frontend:0.0.15
                container_name: agendei-frontend
                restart: always
                depends_on:
                  - backend
                environment:
                  NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:3000"]
                  interval: 30s
                  timeout: 10s
                  retries: 3

              nginx:
                image: nginx:alpine
                container_name: agendei-nginx
                restart: always
                depends_on:
                  - frontend
                  - backend
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                  - ./certbot/conf:/etc/letsencrypt:ro
                  - ./certbot/www:/var/www/certbot:ro
                networks:
                  - agendei-network

            volumes:
              postgres_data:

            networks:
              agendei-network:
                driver: bridge
            EOF

            # Criar arquivo .env se nÃ£o existir
            if [ ! -f .env ]; then
              echo "âš ï¸  Criando arquivo .env - CONFIGURE AS VARIÃVEIS!"
              cat > .env << 'ENVEOF'
            POSTGRES_PASSWORD=***
            JWT_SECRET=***
            JWT_EXPIRATION=24h
            MERCADOPAGO_ACCESS_TOKEN=***

            NEXT_PUBLIC_API_URL=
            ENVEOF
            fi

            # Parar containers antigos
            echo "ðŸ›‘ Parando containers antigos..."
            sudo docker-compose down || true

            # Iniciar novos containers
            echo "ðŸš€ Iniciando novos containers..."
            sudo docker-compose up -d

            # Aguardar backend ficar saudÃ¡vel
            echo "â³ Aguardando backend inicializar..."
            sleep 10

            # Executar migraÃ§Ãµes
            echo "ðŸ“Š Executando migraÃ§Ãµes do banco..."
            sudo docker exec agendei-backend npx prisma migrate deploy || echo "âš ï¸  Erro nas migraÃ§Ãµes - verifique manualmente"

            # Limpar imagens antigas
            echo "ðŸ§¹ Limpando imagens antigas..."
            sudo docker image prune -af --filter "until=72h" || true

            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ðŸ“Š Status dos containers:"
            sudo docker-compose ps
            
            # Login no Docker Hub
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            
            # Pull das novas imagens
            echo "ðŸ“¦ Baixando imagens Docker..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:${{ steps.bump_version.outputs.nova_versao }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:${{ steps.bump_version.outputs.nova_versao }}
            
            # Criar/atualizar docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            version: '3.8'

            services:
              postgres:
                image: postgres:15-alpine
                container_name: agendei-postgres
                restart: always
                environment:
                  POSTGRES_USER: agendei
                  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                  POSTGRES_DB: agendei
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U agendei"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

              backend:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:${{ steps.bump_version.outputs.nova_versao }}
                container_name: agendei-backend
                restart: always
                depends_on:
                  postgres:
                    condition: service_healthy
                environment:
                  PORT: 3001
                  DATABASE_URL: postgresql://agendei:${POSTGRES_PASSWORD}@postgres:5432/agendei
                  JWT_SECRET: ${JWT_SECRET}
                  JWT_EXPIRATION: ${JWT_EXPIRATION:-24h}
                  MERCADOPAGO_ACCESS_TOKEN: ${MERCADOPAGO_ACCESS_TOKEN}
                  NODE_ENV: production
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

              frontend:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:${{ steps.bump_version.outputs.nova_versao }}
                container_name: agendei-frontend
                restart: always
                depends_on:
                  - backend
                environment:
                  NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:3000"]
                  interval: 30s
                  timeout: 10s
                  retries: 3

              nginx:
                image: nginx:alpine
                container_name: agendei-nginx
                restart: always
                depends_on:
                  - frontend
                  - backend
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                  - ./certbot/conf:/etc/letsencrypt:ro
                  - ./certbot/www:/var/www/certbot:ro
                networks:
                  - agendei-network

            volumes:
              postgres_data:

            networks:
              agendei-network:
                driver: bridge
            EOF
            
            # Criar arquivo .env se nÃ£o existir
            if [ ! -f .env ]; then
              echo "âš ï¸  Criando arquivo .env - CONFIGURE AS VARIÃVEIS!"
              cat > .env << 'ENVEOF'
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION=24h
            MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            ENVEOF
            fi
            
            # Parar containers antigos
            echo "ðŸ›‘ Parando containers antigos..."
            docker-compose down || true
            
            # Iniciar novos containers
            echo "ðŸš€ Iniciando novos containers..."
            docker-compose up -d
            
            # Aguardar backend ficar saudÃ¡vel
            echo "â³ Aguardando backend inicializar..."
            sleep 10
            
            # Executar migraÃ§Ãµes
            echo "ðŸ“Š Executando migraÃ§Ãµes do banco..."
            docker exec agendei-backend npx prisma migrate deploy || echo "âš ï¸  Erro nas migraÃ§Ãµes - verifique manualmente"
            
            # Limpar imagens antigas
            echo "ðŸ§¹ Limpando imagens antigas..."
            docker image prune -af --filter "until=72h" || true
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ðŸ“Š Status dos containers:"
            docker-compose ps

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ðŸ”– VersÃ£o: ${{ steps.bump_version.outputs.nova_versao }}"
          echo "ðŸ³ Backend: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:${{ steps.bump_version.outputs.nova_versao }}"
          echo "ðŸ³ Frontend: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:${{ steps.bump_version.outputs.nova_versao }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs acima."
