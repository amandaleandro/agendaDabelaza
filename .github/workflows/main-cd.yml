name: Deploy Agendei - Production

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump (major, minor, patch)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  push:
    branches:
      - main
    paths-ignore:
      - 'VERSION'
      - '**.md'

jobs:
  build-and-deploy:
    name: Build and Deploy to Production
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Ler vers√£o atual do arquivo VERSION
        id: get_version_from_file
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | head -n1 | tr -d ' \n\r')
            echo "Vers√£o atual do arquivo VERSION: $VERSION"
          else
            VERSION="0.0.0"
            echo "Arquivo VERSION n√£o encontrado. Vers√£o inicial ser√° $VERSION"
          fi
          echo "ultima_versao=$VERSION" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump_version
        run: |
          echo "::group::‚¨ÜÔ∏è Calculando pr√≥ximo n√∫mero de vers√£o (${{ github.event.inputs.version_type || 'patch' }})"
          OLD=${{ steps.get_version_from_file.outputs.ultima_versao }}
          TYPE="${{ github.event.inputs.version_type || 'patch' }}"
          IFS='.' read -ra V <<< "${OLD:-0.0.0}"
          MAJOR=${V[0]:-0}
          MINOR=${V[1]:-0}
          PATCH=${V[2]:-0}
          case "$TYPE" in
            major)
              MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0;;
            minor)
              MINOR=$((MINOR+1)); PATCH=0;;
            patch|*)
              PATCH=$((PATCH+1));;
          esac
          NOVA_VERSAO="$MAJOR.$MINOR.$PATCH"
          echo -e "\033[32mNova vers√£o calculada: $NOVA_VERSAO\033[0m"
          echo "$NOVA_VERSAO" > VERSION
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add VERSION
          git commit -m "chore: atualiza vers√£o para $NOVA_VERSAO [skip ci]" || echo "Nenhuma altera√ß√£o no arquivo VERSION"
          git push origin HEAD:${GITHUB_REF#refs/heads/} || echo "Sem push necess√°rio"
          echo "nova_versao=$NOVA_VERSAO" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: backend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:${{ steps.bump_version.outputs.nova_versao }}
            ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:latest
          cache-to: type=inline

      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:${{ steps.bump_version.outputs.nova_versao }}
            ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:latest
          cache-to: type=inline
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Create and push Git tag
        run: |
          TAG_NAME="v${{ steps.bump_version.outputs.nova_versao }}"
          echo "::group::üè∑Ô∏è Criando e enviando tag git: $TAG_NAME"
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release ${{ steps.bump_version.outputs.nova_versao }}"
          git push origin "$TAG_NAME" || echo "Tag j√° existe"
          echo "::endgroup::"

      - name: Deploy to Production Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            set -e
            
            echo "üöÄ Iniciando deploy da vers√£o ${{ steps.bump_version.outputs.nova_versao }}"
            
            # Criar diret√≥rio do projeto se n√£o existir
            mkdir -p ~/agendei
            cd ~/agendei
            
            # Login no Docker Hub
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            
            # Pull das novas imagens
            echo "üì¶ Baixando imagens Docker..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:${{ steps.bump_version.outputs.nova_versao }}
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:${{ steps.bump_version.outputs.nova_versao }}
            
            # Criar/atualizar docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            version: '3.8'

            services:
              postgres:
                image: postgres:15-alpine
                container_name: agendei-postgres
                restart: always
                environment:
                  POSTGRES_USER: agendei
                  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                  POSTGRES_DB: agendei
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U agendei"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

              backend:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:${{ steps.bump_version.outputs.nova_versao }}
                container_name: agendei-backend
                restart: always
                depends_on:
                  postgres:
                    condition: service_healthy
                environment:
                  PORT: 3001
                  DATABASE_URL: postgresql://agendei:${POSTGRES_PASSWORD}@postgres:5432/agendei
                  JWT_SECRET: ${JWT_SECRET}
                  JWT_EXPIRATION: ${JWT_EXPIRATION:-24h}
                  MERCADOPAGO_ACCESS_TOKEN: ${MERCADOPAGO_ACCESS_TOKEN}
                  NODE_ENV: production
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

              frontend:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:${{ steps.bump_version.outputs.nova_versao }}
                container_name: agendei-frontend
                restart: always
                depends_on:
                  - backend
                environment:
                  NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
                networks:
                  - agendei-network
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:3000"]
                  interval: 30s
                  timeout: 10s
                  retries: 3

              nginx:
                image: nginx:alpine
                container_name: agendei-nginx
                restart: always
                depends_on:
                  - frontend
                  - backend
                ports:
                  - "80:80"
                  - "443:443"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                  - ./certbot/conf:/etc/letsencrypt:ro
                  - ./certbot/www:/var/www/certbot:ro
                networks:
                  - agendei-network

            volumes:
              postgres_data:

            networks:
              agendei-network:
                driver: bridge
            EOF
            
            # Criar arquivo .env se n√£o existir
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  Criando arquivo .env - CONFIGURE AS VARI√ÅVEIS!"
              cat > .env << 'ENVEOF'
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION=24h
            MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            ENVEOF
            fi
            
            # Parar containers antigos
            echo "üõë Parando containers antigos..."
            docker-compose down || true
            
            # Iniciar novos containers
            echo "üöÄ Iniciando novos containers..."
            docker-compose up -d
            
            # Aguardar backend ficar saud√°vel
            echo "‚è≥ Aguardando backend inicializar..."
            sleep 10
            
            # Executar migra√ß√µes
            echo "üìä Executando migra√ß√µes do banco..."
            docker exec agendei-backend npx prisma migrate deploy || echo "‚ö†Ô∏è  Erro nas migra√ß√µes - verifique manualmente"
            
            # Limpar imagens antigas
            echo "üßπ Limpando imagens antigas..."
            docker image prune -af --filter "until=72h" || true
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
            echo "üìä Status dos containers:"
            docker-compose ps

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ Deploy realizado com sucesso!"
          echo "üîñ Vers√£o: ${{ steps.bump_version.outputs.nova_versao }}"
          echo "üê≥ Backend: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-backend:${{ steps.bump_version.outputs.nova_versao }}"
          echo "üê≥ Frontend: ${{ secrets.DOCKERHUB_USERNAME }}/agendei-frontend:${{ steps.bump_version.outputs.nova_versao }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Deploy falhou! Verifique os logs acima."
